<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body, html {
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
        /* .tgme_login_button {font-weight:500;background-color:#54a9eb;color:#fff;cursor:pointer;font-size:16px;padding:9px 18px;border-radius:20px;border:none;display:flex;align-items:center} */
    </style>
</head>
<body>
    <!-- app, web, h5 公用此页面 -->
    <!-- 地址： https://telegram-login-dev.dx252.com -->
    <button class="tgme_login_button" id="btn-login">        
        Log in with Telegram
    </button>
    <!-- <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="dxy_web_bot"  data-onauth="onTelegramAuth(user)" data-request-access="write"></script> -->
    <script>

        function loadScript(src, attributes = {}, callback) {
            const script = document.createElement('script');
            script.src = src;

            // 设置自定义属性
            for (const key in attributes) {
                script.setAttribute(key, attributes[key]);
            }

            // 加载完成后的回调
            script.onload = () => {
                if (callback) callback();
            };

            // 处理错误
            script.onerror = () => {
                console.error(`脚本加载失败: ${src}`);
            };

            document.head.appendChild(script);
        }

        var isApp=window.location.search?.includes('app');
        if(isApp){
            // 使用示例
            loadScript('https://telegram.org/js/telegram-widget.js?22', { "data-telegram-login": "dxy_web_bot", "data-onauth": "onTelegramAuth(user)", "data-request-access": "write" }, () => {
                console.log('app  init');
                document.getElementById('btn-login').style.display='none';
            });
        } else {
            loadScript('https://telegram.org/js/telegram-widget.js?22', { "data-onauth": "onTelegramAuth(user)", "data-request-access": "write" }, () => {
                Telegram.Login.init({bot_id:8126791498,"request-access":"write"},u=>{u&&onTelegramAuth(u)});
                console.log('web  init');
                document.getElementById('btn-login').onclick=function(){
                    try{Telegram.Login.open()}catch(e){console.error(e)}
                }
             })
        }


        function onTelegramAuth(u){
            const d=JSON.stringify(u);
            console.log('onTelegramAuth', u)
            try {
                if(isApp){  
                    console.log('post app message', u)
                    window.flutter_inappwebview?.callHandler('NativeBridge',d);
                } else {
                    console.log('post web message', u)
                    window.parent?.postMessage({type:'success',data:d},'*');
                }
            } catch (e) {
                console.error(e)
            }
        }
        
        window.onload=function(){ 
            
            // var isApp=window.location.search?.includes('app');
            // // 只在web端调用
            // if(!isApp){
            //     console.log('web init')
            // Telegram.Login.init({bot_id:8126791498,"request-access":"write"},u=>{u&&onTelegramAuth(u)});
            // }

            // document.getElementById('btn-login').onclick=function(){
            //     try{Telegram.Login.open()}catch(e){console.error(e)}
            // }


        };
    </script>
</body>
</html>
