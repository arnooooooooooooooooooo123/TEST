<script lang="ts" setup>
// import { telegramLoginTemp } from 'vue3-telegram-login'
// import { deleteCookie } from '~/utils/helper'
import { onMounted, ref } from 'vue'

const emit = defineEmits<{
  onSuccess: [token: string]
}>()

const iframeRef = ref<HTMLIFrameElement>()

// function telegramLoadedCallback() {
//   console.log('telegramLoadedCallback')
// }

// function tgLoginCallback(user: any) {
//   console.log(user)
//   emit('onSuccess', JSON.stringify(user))
//   deleteCookie('stel_ssid')
//   deleteCookie('stel_token')
// }

function onSuccessFunction(user: any) {
  console.log(user)
  emit('onSuccess', JSON.stringify(user))
}

function onLoginHandler() {
  console.log('click login', iframeRef.value?.contentWindow)
  iframeRef.value?.contentWindow?.postMessage('login', 'https://arnooooooooooooooooooo123.github.io')
}

onMounted(() => {
  // 监听来自 iframe 的消息
  window.addEventListener('message', (event) => {
    // 验证来源
    console.log('Message from iframe:', event)
    if (event.data === 'success') {
      onSuccessFunction(event.data)
    }
  })
})
</script>

<template>
  <div>
    <div class="login-btn" @click="onLoginHandler">
      <slot />
    </div>
    <iframe ref="iframeRef" class="iframe" src="https://arnooooooooooooooooooo123.github.io/TEST/telegram-login.html#" />
  <!-- <div class="tgLogin" @click="tgLoginCallback"> -->
    <!-- <telegramLoginTemp
      mode="callback"
      telegram-login="dxy_web_bot"
      @loaded="telegramLoadedCallback"
      @callback="tgLoginCallback"
    /> -->
  <!-- </div> -->
  </div>
</template>

<style lang="less" scoped>
// .tgLogin {
//   width: 70px;
//   height: 70px;
//   overflow: hidden;
//   position: absolute;
//   top: 0;
//   opacity: 0;
//   cursor: pointer;
// }

.iframe {
  width: 0;
  height: 0;
  opacity: 0;
}
</style>
